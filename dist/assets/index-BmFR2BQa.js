(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();const V={parse(s,t="VCARD"){const e=s.split(/\r\n|\r|\n/),o=[],n=[];let r=!1;for(const a of e){const[c,i]=a.split(":");if(r||c&&i){if(c==="BEGIN"){const l={};if(i===t)o.push(l),n.push(l);else if(n.at(-1)){if(i==="VBODY"){n.at(-1)[i]="",r=!0;continue}n.at(-1)[i]=l,n.push(l)}continue}if(c==="END"){if(i==="VBODY"){r=!1;continue}n.pop();continue}const m=n.at(-1);if(!m)continue;if(r){m.VBODY+=a+`
`;continue}const[E,...f]=c.split(";"),p=i.split(";");m[E]={...f.length>0?{meta:f.reduce((l,h)=>{const[g,b]=h.split("=");return l[g]=b||!0,l},{})}:{},...p.length>1?{values:p}:{value:i}}}}return o}},F={parse(s){const t=s.split(/\r\n|\r|\n/),e={Date:new Date(0),Body:""};for(const o of t)if(!o.startsWith("CHARSET")){if(o.startsWith("Date:")){const n=o.slice(5).trim();e.Date=new Date(n);continue}else if(o==="")continue;e.Body+=o+`
`}return e}},I=768,O=window.matchMedia(`(width < ${I}px)`),$=()=>O.matches,N=document.getElementById("back"),x=document.querySelector("header .partner"),v=document.querySelector(".col"),w=document.querySelector("label .pick"),D=document.getElementById("file-picker"),y=document.getElementById("vmg-selector"),u=document.getElementById("contacts"),d=document.getElementById("messages"),k=async s=>(await Promise.all(s.map(async e=>{const o=await e.text();return V.parse(o)}))).flat().map(e=>{var a,c,i;const o=((a=e.FN)==null?void 0:a.value)||"",n=((c=e["SORT-STRING"])==null?void 0:c.value)||"",r=((i=e.TEL)==null?void 0:i.value)||"";return{formattedName:o,sortString:n,telNumber:r}}),q=s=>{new Set(s.map(e=>e.name)).forEach(e=>{const o=document.createElement("option");o.value=e,o.textContent=e,y.appendChild(o)}),y.hidden=!1},R=async s=>(await Promise.all(s.map(async e=>{const o=await e.text();return V.parse(o,"VMSG")}))).flat().map(e=>{var f,p,l,h,g,b,L,B,T;const o=((f=e["X-IRMC-TYPE"])==null?void 0:f.value)||"",n=((p=e["X-IRMC-BOX"])==null?void 0:p.value)||"",r=((h=(l=e.VCARD)==null?void 0:l.TEL)==null?void 0:h.value)||"",a=((L=(b=(g=e.VENV)==null?void 0:g.VCARD)==null?void 0:b.TEL)==null?void 0:L.value)||"",c=((T=(B=e.VENV)==null?void 0:B.VENV)==null?void 0:T.VBODY)||"",i=F.parse(c),m=i.Date,E=i.Body;return{type:o,box:n,from:r,to:a,date:m,text:E}}),A=()=>{x.textContent="",y.hidden=!0,[...y.querySelectorAll("option")].filter((t,e)=>e).forEach(t=>t.remove()),u.textContent="",d.textContent=""};let M=[];const j=w.textContent;D.addEventListener("change",async s=>{const t=s.target.files;if(A(),!(t!=null&&t.length)){w.textContent=j;return}const e=[...t].filter(n=>n.type==="text/vcard"||n.type==="text/x-vcard"||n.name.endsWith(".vcf")),o=[...t].filter(n=>n.name.endsWith(".vmg"));w.innerText=`${t.length}個のうち
${e.length+o.length}個の有効なファイル`,M=await k(e),q(o)});const W=async s=>{const t=s.sort((e,o)=>{const n=e.sortString||e.formattedName||e.telNumber,r=o.sortString||o.formattedName||o.telNumber;return n.localeCompare(r)}).map(e=>`<li>
      <button value="${e.telNumber}" data-name="${e.formattedName}">
        ${e.formattedName?`<div class="name">${e.formattedName}</div>`:""}
        <div class="tel">${e.telNumber}</div>
      </button>
    </li>
    `).join(`
`);u.innerHTML=t},X=async s=>{const t=s.filter(e=>e.type==="SMS").sort((e,o)=>e.date.getTime()-o.date.getTime()).map(e=>`<div class="message-box ${e.box.toLowerCase()}" data-box="${e.box}" data-from="${e.from}" data-to="${e.to}">
        <div class="text">${e.text.replace(/\n/g,"<br>")}</div>
        <div class="date">${e.date.toLocaleString()}</div>
      </div>
      `).join(`
`);d.innerHTML=t};let C=[];const Y=()=>new Set(C.map(s=>s.box==="INBOX"?s.from:s.to).filter(s=>s));y.addEventListener("change",async s=>{x.textContent="",u.textContent="",d.textContent="";const t=s.target.value;if(!t)return;const e=[...D.files].filter(r=>r.name===t);C=await R(e);const n=[...Y()].map(r=>M.find(a=>a.telNumber===r)||{formattedName:"",sortString:"",telNumber:r});await W(n)});const S=s=>{var e;const t=s===v?d:v;t.hidden=!0,s.hidden=!1,s===d?N.hidden=!1:(N.hidden=!0,x.textContent="",(e=u.querySelector(".active"))==null||e.classList.remove("active"),d.textContent="")};window.addEventListener("popstate",s=>{var e;const t=(e=s.state)==null?void 0:e.telNumber;if(t){const o=u.querySelector(`button[value="${t}"]`);o?o.click():history.replaceState({},"","/SMSViewer")}else S(v)});N.addEventListener("click",()=>history.back());u.addEventListener("click",async s=>{var r;const t=s.target.closest("button");if(!t)return;(r=u.querySelector(".active"))==null||r.classList.remove("active"),t.classList.add("active");const e=t.dataset.name,o=t.value;x.textContent=e||o;const n=C.filter(a=>(a.box==="INBOX"?a.from:a.to)===o);await X(n),$()&&(S(d),s.isTrusted&&history.pushState({telNumber:o},"","#messages"))});const P=()=>{var s;if($()){const t=u.querySelector(".active"),e=(s=t==null?void 0:t.querySelector("button"))==null?void 0:s.value;t?(S(d),history.pushState({telNumber:e},"","#messages")):S(v)}else N.hidden=!0,v.hidden=d.hidden=!1,history.replaceState({},"","/SMSViewer")};P();O.addEventListener("change",P);
