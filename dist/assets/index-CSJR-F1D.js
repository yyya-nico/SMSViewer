(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const e of document.querySelectorAll('link[rel="modulepreload"]'))o(e);new MutationObserver(e=>{for(const r of e)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function t(e){const r={};return e.integrity&&(r.integrity=e.integrity),e.referrerPolicy&&(r.referrerPolicy=e.referrerPolicy),e.crossOrigin==="use-credentials"?r.credentials="include":e.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(e){if(e.ep)return;e.ep=!0;const r=t(e);fetch(e.href,r)}})();const S={parse(s,n="VCARD"){const t=s.split(/\r\n|\r|\n/),o=[],e=[];let r=!1;for(const a of t){const[l,c]=a.split(":");if(r||l&&c){if(l==="BEGIN"){const i={};if(c===n)o.push(i),e.push(i);else if(e.at(-1)){if(c==="VBODY"){e.at(-1)[c]="",r=!0;continue}e.at(-1)[c]=i,e.push(i)}continue}if(l==="END"){if(c==="VBODY"){r=!1;continue}e.pop();continue}const d=e.at(-1);if(!d)continue;if(r){d.VBODY+=a+`
`;continue}const[N,...u]=l.split(";"),m=c.split(";");d[N]={...u.length>0?{meta:u.reduce((i,v)=>{const[g,y]=v.split("=");return i[g]=y||!0,i},{})}:{},...m.length>1?{values:m}:{value:c}}}}return o}},V={parse(s){const n=s.split(/\r\n|\r|\n/),t={Date:new Date(0),Body:""};for(const o of n)if(!o.startsWith("CHARSET")){if(o.startsWith("Date:")){const e=o.slice(5).trim();t.Date=new Date(e);continue}else if(o==="")continue;t.Body+=o+`
`}return t}},B=document.querySelector("header .partner"),b=document.querySelector("label .pick"),O=document.getElementById("file-picker"),f=document.getElementById("vmg-selector"),p=document.getElementById("contacts"),h=document.getElementById("messages"),w=async s=>(await Promise.all(s.map(async t=>{const o=await t.text();return S.parse(o)}))).flat().map(t=>{var a,l,c;const o=((a=t.FN)==null?void 0:a.value)||"",e=((l=t["SORT-STRING"])==null?void 0:l.value)||"",r=((c=t.TEL)==null?void 0:c.value)||"";return{formattedName:o,sortString:e,telNumber:r}}),D=s=>{s.forEach(n=>{const t=document.createElement("option");t.value=n.name,t.textContent=n.name,f.appendChild(t)}),f.hidden=!1},$=async s=>(await Promise.all(s.map(async t=>{const o=await t.text();return S.parse(o,"VMSG")}))).flat().map(t=>{var u,m,i,v,g,y,C,E,L;const o=((u=t["X-IRMC-TYPE"])==null?void 0:u.value)||"",e=((m=t["X-IRMC-BOX"])==null?void 0:m.value)||"",r=((v=(i=t.VCARD)==null?void 0:i.TEL)==null?void 0:v.value)||"",a=((C=(y=(g=t.VENV)==null?void 0:g.VCARD)==null?void 0:y.TEL)==null?void 0:C.value)||"",l=((L=(E=t.VENV)==null?void 0:E.VENV)==null?void 0:L.VBODY)||"",c=V.parse(l),d=c.Date,N=c.Body;return{type:o,box:e,from:r,to:a,date:d,text:N}}),P=()=>{B.textContent="",f.hidden=!0,[...f.querySelectorAll("option")].filter((n,t)=>t).forEach(n=>n.remove()),p.textContent="",h.textContent=""};let T=[];const I=b.textContent;O.addEventListener("change",async s=>{const n=s.target.files;if(P(),!(n!=null&&n.length)){b.textContent=I;return}const t=[...n].filter(e=>e.type==="text/vcard"||e.type==="text/x-vcard"||e.name.endsWith(".vcf")),o=[...n].filter(e=>e.name.endsWith(".vmg"));b.innerText=`${n.length}個のうち
${t.length+o.length}個の有効なファイル`,T=await w(t),D(o)});const F=async s=>{const n=s.sort((t,o)=>{const e=t.sortString||t.formattedName||t.telNumber,r=o.sortString||o.formattedName||o.telNumber;return e.localeCompare(r)}).map(t=>`<li>
      <button value="${t.telNumber}" data-name="${t.formattedName}">
        ${t.formattedName?`<div class="name">${t.formattedName}</div>`:""}
        <div class="tel">${t.telNumber}</div>
      </button>
    </li>
    `).join(`
`);p.innerHTML=n},M=async s=>{const n=s.filter(t=>t.type==="SMS").sort((t,o)=>t.date.getTime()-o.date.getTime()).map(t=>`<div class="message-box ${t.box.toLowerCase()}" data-box="${t.box}" data-from="${t.from}" data-to="${t.to}">
        <div class="text">${t.text.replace(/\n/g,"<br>")}</div>
        <div class="date">${t.date.toLocaleString()}</div>
      </div>
      `).join(`
`);h.innerHTML=n};let x=[];const R=()=>new Set(x.map(s=>s.box==="INBOX"?s.from:s.to).filter(s=>s));f.addEventListener("change",async s=>{p.textContent="",h.textContent="";const n=s.target.value;if(!n)return;const t=[...O.files].filter(r=>r.name===n);x=await $(t);const e=[...R()].map(r=>T.find(a=>a.telNumber===r)||{formattedName:"",sortString:"",telNumber:r});await F(e)});p.addEventListener("click",async s=>{var e;const n=s.target.closest("button");if(!n)return;(e=p.querySelector(".active"))==null||e.classList.remove("active"),n.classList.add("active");const t=n.value;B.textContent=n.dataset.name||n.value;const o=x.filter(r=>(r.box==="INBOX"?r.from:r.to)===t);await M(o)});
