(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();const k=e=>e.replace(/[&'`"<>]/g,n=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[n]||""),q=e=>e.replace(/\n/g,"<br>"),R=(e,n)=>{const t={};for(const o in e)t[o]=n(e[o]);return t},O={parse(e,n="VCARD"){const t=e.split(/\r\n|\r|\n/),o=[],s=[];let r=!1;for(const a of t){const[i,c]=a.split(":");if(r||i&&c){if(i==="BEGIN"){const l={};if(c===n)o.push(l),s.push(l);else if(s.at(-1)){if(c==="VBODY"){s.at(-1)[c]="",r=!0;continue}s.at(-1)[c]=l,s.push(l)}continue}if(i==="END"){if(c==="VBODY"){r=!1;continue}s.pop();continue}const m=s.at(-1);if(!m)continue;if(r){m.VBODY+=a+`
`;continue}const[w,...f]=i.split(";"),p=c.split(";");m[w]={...f.length>0?{meta:f.reduce((l,y)=>{const[g,b]=y.split("=");return l[g]=b||!0,l},{})}:{},...p.length>1?{values:p}:{value:c}}}}return o}},A={parse(e){const n=e.split(/\r\n|\r|\n/),t={Date:new Date(0),Body:""};for(const o of n)if(!o.startsWith("CHARSET")){if(o.startsWith("Date:")){const s=o.slice(5).trim();t.Date=new Date(s);continue}else if(o==="")continue;t.Body+=o+`
`}return t}},x=document.title,j=768,$=window.matchMedia(`(width < ${j}px)`),D=()=>$.matches,N=document.getElementById("back"),E=document.querySelector("header .partner"),v=document.querySelector(".col"),C=document.querySelector("label .pick"),M=document.getElementById("file-picker"),h=document.getElementById("vmg-selector"),u=document.getElementById("contacts"),d=document.getElementById("messages"),W=async e=>(await Promise.all(e.map(async t=>{const o=await t.text();return O.parse(o)}))).flat().map(t=>{var a,i,c;const o=((a=t.FN)==null?void 0:a.value)||"",s=((i=t["SORT-STRING"])==null?void 0:i.value)||"",r=((c=t.TEL)==null?void 0:c.value)||"";return{formattedName:o,sortString:s,telNumber:r}}),X=e=>{new Set(e.map(t=>t.name)).forEach(t=>{const o=document.createElement("option");o.value=t,o.textContent=t,h.appendChild(o)}),h.hidden=!1},Y=async e=>(await Promise.all(e.map(async t=>{const o=await t.text();return O.parse(o,"VMSG")}))).flat().map(t=>{var f,p,l,y,g,b,T,V,B;const o=((f=t["X-IRMC-TYPE"])==null?void 0:f.value)||"",s=((p=t["X-IRMC-BOX"])==null?void 0:p.value)||"",r=((y=(l=t.VCARD)==null?void 0:l.TEL)==null?void 0:y.value)||"",a=((T=(b=(g=t.VENV)==null?void 0:g.VCARD)==null?void 0:b.TEL)==null?void 0:T.value)||"",i=((B=(V=t.VENV)==null?void 0:V.VENV)==null?void 0:B.VBODY)||"",c=A.parse(i),m=c.Date,w=c.Body;return{type:o,box:s,from:r,to:a,date:m,text:w}}),H=()=>{document.title=x,E.textContent="",h.hidden=!0,[...h.querySelectorAll("option")].filter((n,t)=>t).forEach(n=>n.remove()),u.textContent="",d.textContent=""};let P=[];const G=C.textContent;M.addEventListener("change",async e=>{const n=e.target.files;if(H(),!(n!=null&&n.length)){C.textContent=G;return}const t=[...n].filter(s=>s.type==="text/vcard"||s.type==="text/x-vcard"||s.name.endsWith(".vcf")),o=[...n].filter(s=>s.name.endsWith(".vmg"));C.innerText=`${n.length}個のうち
${t.length+o.length}個の有効なファイル`,P=await W(t),X(o)});const F=e=>R(e,k),K=async e=>{const n=e.sort((t,o)=>{const s=t.sortString||t.formattedName||t.telNumber,r=o.sortString||o.formattedName||o.telNumber;return s.localeCompare(r)}).map(F).map(t=>`<li>
      <button value="${t.telNumber}" data-name="${t.formattedName}">
        ${t.formattedName?`<div class="name">${t.formattedName}</div>`:""}
        <div class="tel">${t.telNumber}</div>
      </button>
    </li>
    `).join(`
`);u.innerHTML=n},_=async e=>{const n=e.filter(t=>t.type==="SMS").sort((t,o)=>t.date.getTime()-o.date.getTime()).map(t=>({...t,date:t.date.toLocaleString()})).map(F).map(t=>`<div class="message-box ${t.box.toLowerCase()}" data-box="${t.box}" data-from="${t.from}" data-to="${t.to}">
        <div class="text">${q(t.text)}</div>
        <div class="date">${t.date}</div>
      </div>
      `).join(`
`);d.innerHTML=n};let L=[];const z=()=>new Set(L.map(e=>e.box==="INBOX"?e.from:e.to).filter(e=>e));h.addEventListener("change",async e=>{document.title=x,E.textContent="",u.textContent="",d.textContent="";const n=e.target.value;if(!n)return;const t=[...M.files].filter(r=>r.name===n);L=await Y(t);const s=[...z()].map(r=>P.find(a=>a.telNumber===r)||{formattedName:"",sortString:"",telNumber:r});await K(s)});const S=e=>{var t;const n=e===v?d:v;n.hidden=!0,e.hidden=!1,e===d?N.hidden=!1:(N.hidden=!0,document.title=x,E.textContent="",(t=u.querySelector(".active"))==null||t.classList.remove("active"),d.textContent="")};window.addEventListener("popstate",e=>{var t;const n=(t=e.state)==null?void 0:t.telNumber;if(n){const o=u.querySelector(`button[value="${n}"]`);o?o.click():history.replaceState({},"","/SMSViewer")}else S(v)});N.addEventListener("click",()=>history.back());u.addEventListener("click",async e=>{var r;const n=e.target.closest("button");if(!n)return;(r=u.querySelector(".active"))==null||r.classList.remove("active"),n.classList.add("active");const t=n.dataset.name,o=n.value;document.title=`${x} - ${t||o}`,E.textContent=t||o;const s=L.filter(a=>(a.box==="INBOX"?a.from:a.to)===o);await _(s),D()&&(S(d),e.isTrusted&&history.pushState({telNumber:o},"","#messages"))});const I=()=>{var e;if(D()){const n=u.querySelector(".active"),t=(e=n==null?void 0:n.querySelector("button"))==null?void 0:e.value;n?(S(d),history.pushState({telNumber:t},"","#messages")):S(v)}else N.hidden=!0,v.hidden=d.hidden=!1,history.replaceState({},"","/SMSViewer")};I();$.addEventListener("change",I);
