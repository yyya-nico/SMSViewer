(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(o){if(o.ep)return;o.ep=!0;const r=t(o);fetch(o.href,r)}})();const O={parse(s,e="VCARD"){const t=s.split(/\r\n|\r|\n/),n=[],o=[];let r=!1;for(const i of t){const[c,a]=i.split(":");if(r||c&&a){if(c==="BEGIN"){const l={};if(a===e)n.push(l),o.push(l);else if(o.at(-1)){if(a==="VBODY"){o.at(-1)[a]="",r=!0;continue}o.at(-1)[a]=l,o.push(l)}continue}if(c==="END"){if(a==="VBODY"){r=!1;continue}o.pop();continue}const m=o.at(-1);if(!m)continue;if(r){m.VBODY+=i+`
`;continue}const[w,...f]=c.split(";"),p=a.split(";");m[w]={...f.length>0?{meta:f.reduce((l,h)=>{const[g,b]=h.split("=");return l[g]=b||!0,l},{})}:{},...p.length>1?{values:p}:{value:a}}}}return n}},I={parse(s){const e=s.split(/\r\n|\r|\n/),t={Date:new Date(0),Body:""};for(const n of e)if(!n.startsWith("CHARSET")){if(n.startsWith("Date:")){const o=n.slice(5).trim();t.Date=new Date(o);continue}else if(n==="")continue;t.Body+=n+`
`}return t}},x=document.title,k=768,$=window.matchMedia(`(width < ${k}px)`),D=()=>$.matches,N=document.getElementById("back"),E=document.querySelector("header .partner"),v=document.querySelector(".col"),C=document.querySelector("label .pick"),M=document.getElementById("file-picker"),y=document.getElementById("vmg-selector"),u=document.getElementById("contacts"),d=document.getElementById("messages"),q=async s=>(await Promise.all(s.map(async t=>{const n=await t.text();return O.parse(n)}))).flat().map(t=>{var i,c,a;const n=((i=t.FN)==null?void 0:i.value)||"",o=((c=t["SORT-STRING"])==null?void 0:c.value)||"",r=((a=t.TEL)==null?void 0:a.value)||"";return{formattedName:n,sortString:o,telNumber:r}}),R=s=>{new Set(s.map(t=>t.name)).forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,y.appendChild(n)}),y.hidden=!1},A=async s=>(await Promise.all(s.map(async t=>{const n=await t.text();return O.parse(n,"VMSG")}))).flat().map(t=>{var f,p,l,h,g,b,T,B,V;const n=((f=t["X-IRMC-TYPE"])==null?void 0:f.value)||"",o=((p=t["X-IRMC-BOX"])==null?void 0:p.value)||"",r=((h=(l=t.VCARD)==null?void 0:l.TEL)==null?void 0:h.value)||"",i=((T=(b=(g=t.VENV)==null?void 0:g.VCARD)==null?void 0:b.TEL)==null?void 0:T.value)||"",c=((V=(B=t.VENV)==null?void 0:B.VENV)==null?void 0:V.VBODY)||"",a=I.parse(c),m=a.Date,w=a.Body;return{type:n,box:o,from:r,to:i,date:m,text:w}}),j=()=>{document.title=x,E.textContent="",y.hidden=!0,[...y.querySelectorAll("option")].filter((e,t)=>t).forEach(e=>e.remove()),u.textContent="",d.textContent=""};let P=[];const W=C.textContent;M.addEventListener("change",async s=>{const e=s.target.files;if(j(),!(e!=null&&e.length)){C.textContent=W;return}const t=[...e].filter(o=>o.type==="text/vcard"||o.type==="text/x-vcard"||o.name.endsWith(".vcf")),n=[...e].filter(o=>o.name.endsWith(".vmg"));C.innerText=`${e.length}個のうち
${t.length+n.length}個の有効なファイル`,P=await q(t),R(n)});const X=async s=>{const e=s.sort((t,n)=>{const o=t.sortString||t.formattedName||t.telNumber,r=n.sortString||n.formattedName||n.telNumber;return o.localeCompare(r)}).map(t=>`<li>
      <button value="${t.telNumber}" data-name="${t.formattedName}">
        ${t.formattedName?`<div class="name">${t.formattedName}</div>`:""}
        <div class="tel">${t.telNumber}</div>
      </button>
    </li>
    `).join(`
`);u.innerHTML=e},Y=async s=>{const e=s.filter(t=>t.type==="SMS").sort((t,n)=>t.date.getTime()-n.date.getTime()).map(t=>`<div class="message-box ${t.box.toLowerCase()}" data-box="${t.box}" data-from="${t.from}" data-to="${t.to}">
        <div class="text">${t.text.replace(/\n/g,"<br>")}</div>
        <div class="date">${t.date.toLocaleString()}</div>
      </div>
      `).join(`
`);d.innerHTML=e};let L=[];const G=()=>new Set(L.map(s=>s.box==="INBOX"?s.from:s.to).filter(s=>s));y.addEventListener("change",async s=>{document.title=x,E.textContent="",u.textContent="",d.textContent="";const e=s.target.value;if(!e)return;const t=[...M.files].filter(r=>r.name===e);L=await A(t);const o=[...G()].map(r=>P.find(i=>i.telNumber===r)||{formattedName:"",sortString:"",telNumber:r});await X(o)});const S=s=>{var t;const e=s===v?d:v;e.hidden=!0,s.hidden=!1,s===d?N.hidden=!1:(N.hidden=!0,document.title=x,E.textContent="",(t=u.querySelector(".active"))==null||t.classList.remove("active"),d.textContent="")};window.addEventListener("popstate",s=>{var t;const e=(t=s.state)==null?void 0:t.telNumber;if(e){const n=u.querySelector(`button[value="${e}"]`);n?n.click():history.replaceState({},"","/SMSViewer")}else S(v)});N.addEventListener("click",()=>history.back());u.addEventListener("click",async s=>{var r;const e=s.target.closest("button");if(!e)return;(r=u.querySelector(".active"))==null||r.classList.remove("active"),e.classList.add("active");const t=e.dataset.name,n=e.value;document.title=`${x} - ${t||n}`,E.textContent=t||n;const o=L.filter(i=>(i.box==="INBOX"?i.from:i.to)===n);await Y(o),D()&&(S(d),s.isTrusted&&history.pushState({telNumber:n},"","#messages"))});const F=()=>{var s;if(D()){const e=u.querySelector(".active"),t=(s=e==null?void 0:e.querySelector("button"))==null?void 0:s.value;e?(S(d),history.pushState({telNumber:t},"","#messages")):S(v)}else N.hidden=!0,v.hidden=d.hidden=!1,history.replaceState({},"","/SMSViewer")};F();$.addEventListener("change",F);
