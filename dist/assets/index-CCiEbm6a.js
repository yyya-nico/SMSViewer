(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();const j=e=>e.replace(/[&'`"<>]/g,o=>({"&":"&amp;","'":"&#x27;","`":"&#x60;",'"':"&quot;","<":"&lt;",">":"&gt;"})[o]||""),H=e=>e.replace(/\n/g,"<br>"),W=(e,o)=>{const t={};for(const n in e)t[n]=o(e[n]);return t},$={parse(e,o="VCARD"){const t=e.split(/\r\n|\r|\n/),n=[],s=[];let r=!1;for(const a of t){const[i,c]=a.split(":");if(r||i&&c){if(i==="BEGIN"){const l={};if(c===o)n.push(l),s.push(l);else if(s.at(-1)){if(c==="VBODY"){s.at(-1)[c]="",r=!0;continue}s.at(-1)[c]=l,s.push(l)}continue}if(i==="END"){if(c==="VBODY"){r=!1;continue}s.pop();continue}const f=s.at(-1);if(!f)continue;if(r){f.VBODY+=a+`
`;continue}const[L,...v]=i.split(";"),y=c.split(";");f[L]={...v.length>0?{meta:v.reduce((l,g)=>{const[S,b]=g.split("=");return l[S]=b||!0,l},{})}:{},...y.length>1?{values:y}:{value:c}}}}return n}},Y={parse(e){const o=e.split(/\r\n|\r|\n/),t={Date:new Date(0),Body:""};for(const n of o)if(!n.startsWith("CHARSET")){if(n.startsWith("Date:")){const s=n.slice(5).trim();t.Date=new Date(s);continue}else if(n==="")continue;t.Body+=n+`
`}return t}},E=document.title,G=768,D=window.matchMedia(`(width < ${G}px)`),P=()=>D.matches,x=document.getElementById("back"),w=document.querySelector("header .partner"),h=document.querySelector(".col"),T=document.querySelector("label .pick"),F=document.getElementById("file-picker"),u=document.getElementById("try-sample"),k=document.getElementById("vmg-selector-label"),N=document.getElementById("vmg-selector"),m=document.getElementById("contacts"),d=document.getElementById("messages"),K=async e=>(await Promise.all(e.map(async t=>{const n=await t.text();return $.parse(n)}))).flat().map(t=>{var a,i,c;const n=((a=t.FN)==null?void 0:a.value)||"",s=((i=t["SORT-STRING"])==null?void 0:i.value)||"",r=((c=t.TEL)==null?void 0:c.value)||"";return{formattedName:n,sortString:s,telNumber:r}}),z=e=>{new Set(e.map(t=>t.name)).forEach(t=>{const n=document.createElement("option");n.value=t,n.textContent=t,N.appendChild(n)}),k.hidden=!1,N.dispatchEvent(new Event("change"))},J=async e=>(await Promise.all(e.map(async t=>{const n=await t.text();return $.parse(n,"VMSG")}))).flat().map(t=>{var v,y,l,g,S,b,O,M,I;const n=((v=t["X-IRMC-TYPE"])==null?void 0:v.value)||"",s=((y=t["X-IRMC-BOX"])==null?void 0:y.value)||"",r=((g=(l=t.VCARD)==null?void 0:l.TEL)==null?void 0:g.value)||"",a=((O=(b=(S=t.VENV)==null?void 0:S.VCARD)==null?void 0:b.TEL)==null?void 0:O.value)||"",i=((I=(M=t.VENV)==null?void 0:M.VENV)==null?void 0:I.VBODY)||"",c=Y.parse(i),f=c.Date,L=c.Body;return{type:n,box:s,from:r,to:a,date:f,text:L}}),Q=()=>{document.title=E,w.textContent="",k.hidden=!0,N.textContent="",m.textContent="",d.textContent=""};let q=[];const U=T.textContent,A=async e=>{if(Q(),!(e!=null&&e.length)){T.textContent=U;return}const o=[...e].filter(n=>n.type==="text/vcard"||n.type==="text/x-vcard"||n.name.endsWith(".vcf")),t=[...e].filter(n=>n.name.endsWith(".vmg"));T.innerText=`${e.length}個のうち
${o.length+t.length}個の有効なファイル`,q=await K(o),z(t)},B=u.textContent;let p=null;F.addEventListener("change",e=>{u.textContent=B,u.disabled=e.target.value!=="",p=e.target.files,A(p)});const Z=()=>u.textContent!==B;u.addEventListener("click",async()=>{if(Z())p=null,u.textContent=B;else{const e=["SMSViewer/Sample/CONTACTS/Contacts.vcf","SMSViewer/Sample/MAIL/INBOX/Sample.vmg","SMSViewer/Sample/MAIL/SENTBOX/Sample.vmg"];p=await Promise.all(e.map(o=>fetch(o).then(t=>t.blob()).then(t=>new File([t],o.split("/").pop()||"")))),u.textContent="サンプルを非表示"}F.value="",A(p)});const R=e=>W(e,j),_=async e=>{const o=e.sort((t,n)=>{const s=t.sortString||t.formattedName||t.telNumber,r=n.sortString||n.formattedName||n.telNumber;return s.localeCompare(r)}).map(R).map(t=>`<li>
      <button value="${t.telNumber}" data-name="${t.formattedName}">
        ${t.formattedName?`<div class="name">${t.formattedName}</div>`:""}
        <div class="tel">${t.telNumber}</div>
      </button>
    </li>
    `).join(`
`);m.innerHTML=o},tt=async e=>{const o=e.filter(t=>t.type==="SMS").sort((t,n)=>t.date.getTime()-n.date.getTime()).map(t=>({...t,date:t.date.toLocaleString()})).map(R).map(t=>`<div class="message-box ${t.box.toLowerCase()}" data-box="${t.box}" data-from="${t.from}" data-to="${t.to}">
        <div class="text">${H(t.text)}</div>
        <div class="date">${t.date}</div>
      </div>
      `).join(`
`);d.innerHTML=o};let V=[];const et=()=>new Set(V.map(e=>e.box==="INBOX"?e.from:e.to).filter(e=>e));N.addEventListener("change",async e=>{document.title=E,w.textContent="",m.textContent="",d.textContent="";const o=e.target.value;if(!o)return;const t=[...p].filter(r=>r.name===o);V=await J(t);const s=[...et()].map(r=>q.find(a=>a.telNumber===r)||{formattedName:"",sortString:"",telNumber:r});await _(s)});const C=e=>{var t;const o=e===h?d:h;o.hidden=!0,e.hidden=!1,e===d?x.hidden=!1:(x.hidden=!0,document.title=E,w.textContent="",(t=m.querySelector(".active"))==null||t.classList.remove("active"),d.textContent="")};window.addEventListener("popstate",e=>{var t;const o=(t=e.state)==null?void 0:t.telNumber;if(o){const n=m.querySelector(`button[value="${o}"]`);n?n.click():history.replaceState({},"","/SMSViewer")}else C(h)});x.addEventListener("click",()=>history.back());m.addEventListener("click",async e=>{var r;const o=e.target.closest("button");if(!o)return;(r=m.querySelector(".active"))==null||r.classList.remove("active"),o.classList.add("active");const t=o.dataset.name,n=o.value;document.title=`${E} - ${t||n}`,w.textContent=t||n;const s=V.filter(a=>(a.box==="INBOX"?a.from:a.to)===n);await tt(s),P()&&(C(d),e.isTrusted&&history.pushState({telNumber:n},"","#messages"))});const X=()=>{var e;if(P()){const o=m.querySelector(".active"),t=(e=o==null?void 0:o.querySelector("button"))==null?void 0:e.value;o?(C(d),history.pushState({telNumber:t},"","#messages")):C(h)}else x.hidden=!0,h.hidden=d.hidden=!1,history.replaceState({},"","/SMSViewer")};X();D.addEventListener("change",X);
